<Page x:Class="Pkn_HostSystem.Views.Pages.HomePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:page="clr-namespace:Pkn_HostSystem.ViewModels.Page"
      xmlns:converter="clr-namespace:Pkn_HostSystem.Base.Converter"
      d:DataContext="{d:DesignInstance page:HomePageViewModel}"
      d:DesignHeight="714.5" d:DesignWidth="1000"
      ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
      ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
      Foreground="{DynamicResource TextFillColorPrimaryBrush}"
      mc:Ignorable="d"
      Title="HomePage">
    <Page.Resources>
        <!-- 展开动画 -->
        <Storyboard x:Key="OPENcontentPLC">
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="border"
                                           Storyboard.TargetProperty="(FrameworkElement.Width)">
                <EasingDoubleKeyFrame KeyTime="00:00:00.3000000" Value="400" />
            </DoubleAnimationUsingKeyFrames>
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="border"
                                           Storyboard.TargetProperty="(FrameworkElement.Height)">
                <EasingDoubleKeyFrame KeyTime="00:00:00.3000000" Value="600" />
            </DoubleAnimationUsingKeyFrames>
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="border"
                                           Storyboard.TargetProperty="(UIElement.Opacity)">
                <EasingDoubleKeyFrame KeyTime="00:00:00.3000000" Value="1" />
            </DoubleAnimationUsingKeyFrames>
        </Storyboard>
        <!-- 收缩动画 -->
        <Storyboard x:Key="CLOSEcontentPLC">
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="border"
                                           Storyboard.TargetProperty="(FrameworkElement.Width)">
                <EasingDoubleKeyFrame KeyTime="00:00:00.3000000" Value="0" />
            </DoubleAnimationUsingKeyFrames>
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="border"
                                           Storyboard.TargetProperty="(FrameworkElement.Height)">
                <EasingDoubleKeyFrame KeyTime="00:00:00.3000000" Value="0" />
            </DoubleAnimationUsingKeyFrames>
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="border"
                                           Storyboard.TargetProperty="(UIElement.Opacity)">
                <EasingDoubleKeyFrame KeyTime="00:00:00.3000000" Value="0" />
            </DoubleAnimationUsingKeyFrames>
        </Storyboard>

        <converter:NewRowAllowButtonConverter x:Key="HomePageRunButtonConverter" />

    </Page.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Grid>
            <WrapPanel Height="600" Width="450">
                <ui:CardAction
                    Name="CA_ConnectPLC"
                    Width="180"
                    Height="102"
                    IsChevronVisible="False"
                    VerticalAlignment="Stretch" Click="CA_ConnectPLC_Click">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Image
                            Width="60"
                            Margin="0,0,0,15"
                            Source="../../Assets/plc2.ico" />
                        <ui:TextBlock Grid.Column="1" Text="连接PLC" VerticalAlignment="Center" />
                    </Grid>
                </ui:CardAction>
                <Border x:Name="border" Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}"
                        Width="180"
                        CornerRadius="10"
                        Opacity="0"
                        Visibility="Collapsed"
                        Height="102" BorderThickness="1" RenderTransformOrigin="0.5,0.5">
                    <Border.RenderTransform>
                        <TransformGroup>
                            <ScaleTransform />
                            <SkewTransform />
                            <RotateTransform />
                            <TranslateTransform />
                        </TransformGroup>
                    </Border.RenderTransform>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                            <RowDefinition Height="auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Margin="15,0">
                            <TextBlock Text="连接目标" Margin="0,15" />
                            <DataGrid
                                Name="setConnectDg"
                                Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}"
                                ItemsSource="{Binding HomePageModel.SetConnectDg}"
                                Width="400"
                                Height="200"
                                AutoGenerateColumns="False"
                                CellEditEnding="SetConnectDg_OnCellEditEnding">

                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="连接名" Width="*" Binding="{Binding Name  }" />
                                    <DataGridTemplateColumn Width="0.8*" Header="配置">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Grid>
                                                    <Button Name="配置" Content="配置"
                                                            Command="{Binding HomePageViewModel.SetConnectConfigCommand,RelativeSource={RelativeSource AncestorType=Page}}"
                                                            CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=Page} }">
                                                        <Button.IsEnabled>
                                                            <MultiBinding
                                                                Converter="{StaticResource HomePageRunButtonConverter}">
                                                                <!-- 绑定 IsNewItem -->
                                                                <Binding
                                                                    RelativeSource="{RelativeSource AncestorType=DataGridRow}"
                                                                    Path="IsNewItem" />
                                                                <!-- 绑定 NoSet -->
                                                                <Binding Path="Open" />
                                                            </MultiBinding>
                                                        </Button.IsEnabled>
                                                    </Button>
                                                </Grid>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTemplateColumn Header="启动" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Grid>
                                                    <ui:ToggleSwitch OffContent="关闭" OnContent="启动"
                                                                     IsChecked="{Binding Open ,UpdateSourceTrigger=PropertyChanged}"

                                                                     Command="{Binding DataContext.ConnectModbusCommand ,RelativeSource={RelativeSource AncestorType=Page}}"
                                                                     CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=Page}}">

                                                        <ui:ToggleSwitch.IsEnabled>
                                                            <MultiBinding
                                                                Converter="{StaticResource HomePageRunButtonConverter}">
                                                                <Binding
                                                                    RelativeSource="{RelativeSource AncestorType=DataGridRow}"
                                                                    Path="IsNewItem" />
                                                                <Binding Path="Open" />
                                                            </MultiBinding>
                                                        </ui:ToggleSwitch.IsEnabled>
                                                    </ui:ToggleSwitch>
                                                </Grid>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Header="删除" Width="0.9*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Grid>
                                                    <CheckBox
                                                        Command="{Binding DataContext.DeleteReadRegDvgCommand  ,RelativeSource={RelativeSource AncestorType=Page}}"
                                                        CommandParameter="{Binding  RelativeSource={RelativeSource AncestorType=Page} }">
                                                        <CheckBox.IsEnabled>
                                                            <MultiBinding
                                                                Converter="{StaticResource HomePageRunButtonConverter}">
                                                                <Binding
                                                                    RelativeSource="{RelativeSource AncestorType=DataGridRow}"
                                                                    Path="IsNewItem" />
                                                                <Binding Path="Open" />
                                                            </MultiBinding>
                                                        </CheckBox.IsEnabled>
                                                    </CheckBox>
                                                </Grid>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>

                            <Border
                                Name="IpSet"
                                Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}"
                                Margin="0, 15"
                                CornerRadius="10"
                                MinWidth="370"
                                Visibility="Collapsed">
                                <StackPanel>
                                    <Border
                                        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}"
                                        BorderThickness="0,1,0,1"
                                        Margin="4">
                                        <TextBlock Text="{Binding HomePageModel.CurrentSetName}" Margin="10" />
                                    </Border>
                                    <Border
                                        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}"
                                        BorderThickness="0,0,0,1"
                                        Margin="4">
                                        <WrapPanel>
                                            <TextBlock Text="当前选择的通讯" Margin="10" TextAlignment="Center" />
                                            <ComboBox Width="150" ItemsSource="{Binding NetMethod}"
                                                      SelectedValue="{Binding ModbusToolModel.NetMethod_select}" />
                                            <Button Content="设置" HorizontalAlignment="Right" Margin="20,5"
                                                    Command="{Binding CommitConfigCommand}"
                                                    CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=Page} }" />
                                        </WrapPanel>
                                    </Border>

                                    <TabControl HorizontalAlignment="Left" Margin="0,0,0,15">
                                        <TabItem Width="122">
                                            <TabItem.Header>
                                                <TextBlock FontWeight="Bold" FontSize="13" Text="TCP通讯设置" />
                                            </TabItem.Header>
                                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                                <WrapPanel Margin="5 ">
                                                    <Border Margin="5">
                                                        <TextBlock Text="IP地址" FontSize="15"
                                                                   HorizontalAlignment="Center"
                                                                   VerticalAlignment="Center" />
                                                    </Border>

                                                    <TextBox  Width="250"     Text="{Binding ModbusToolModel.ModbusTcp_Ip_select ,UpdateSourceTrigger=PropertyChanged}" ></TextBox>
                                                    <!-- <ComboBox Name="cbb_modbus_tpc_ip" Width="250" -->
                                                    <!--           ItemsSource="{Binding ModbusToolModel.ModbusTcp_Ip}" -->
                                                    <!--           SelectedIndex="0" -->
                                                    <!--           Text="{Binding ModbusToolModel.ModbusTcp_Ip_select}" -->
                                                    <!--           DropDownOpened="ComboBox_DropDownOpened_1" /> -->
                                                </WrapPanel>
                                                <WrapPanel Margin="5">
                                                    <Border Margin="5">
                                                        <TextBlock Text="端口号" FontSize="15"
                                                                   HorizontalAlignment="Center"
                                                                   VerticalAlignment="Center" />
                                                    </Border>
                                                    <ui:NumberBox Width="250"
                                                                  Value="{Binding ModbusToolModel.ModbusTcp_Port,UpdateSourceTrigger=PropertyChanged}"
                                                                  Minimum="0" Maximum="65535" />
                                                </WrapPanel>
                                            </StackPanel>
                                        </TabItem>
                                        <TabItem Width="122">
                                            <TabItem.Header>
                                                <TextBlock FontWeight="Bold" FontSize="13" Text="串口通讯设置" />
                                            </TabItem.Header>
                                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                <WrapPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0 5">
                                                        <Border VerticalAlignment="Center" Width="58">
                                                            <TextBlock Text="端口号" HorizontalAlignment="Right"
                                                                       Margin="5" />
                                                        </Border>
                                                        <ComboBox Margin="0 0 10 0" Width="90"
                                                                  ItemsSource="{Binding ModbusToolModel.ModbusRtu_COM}"
                                                                  SelectedIndex="0"
                                                                  DropDownOpened="ComboBox_DropDownOpened"
                                                                  Text="{Binding ModbusToolModel.ModbusRtu_COM_select}" />
                                                    </StackPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0 5">

                                                        <Border HorizontalAlignment="Center" Width="58"
                                                                VerticalAlignment="Center">
                                                            <TextBlock Text="波特率" Margin="5"
                                                                       HorizontalAlignment="Right" />
                                                        </Border>
                                                        <ComboBox Margin="0 0 10 0" Width="90"
                                                                  ItemsSource="{Binding ModbusToolModel.ModbusRtu_baudRate}"
                                                                  SelectedIndex="0"
                                                                  Text="{Binding ModbusToolModel.ModbusRtu_baudRate_select}" />
                                                    </StackPanel>

                                                </WrapPanel>
                                                <WrapPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0 5">
                                                        <Border HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"
                                                                Width="58">
                                                            <TextBlock Text="数据位" HorizontalAlignment="Right"
                                                                       Margin="5" />
                                                        </Border>
                                                        <ComboBox Margin="0 0 10 0" Width="90"
                                                                  ItemsSource="{Binding ModbusToolModel.ModbusRtu_dataBits}"
                                                                  SelectedIndex="0"
                                                                  Text="{Binding ModbusToolModel.ModbusRtu_dataBits_select}" />
                                                    </StackPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0 5">

                                                        <Border HorizontalAlignment="Center" Width="58"
                                                                VerticalAlignment="Center">
                                                            <TextBlock Text="停止位" Margin="5"
                                                                       HorizontalAlignment="Right" />
                                                        </Border>
                                                        <ComboBox Width="90"
                                                                  ItemsSource="{Binding ModbusToolModel.ModbusRtu_stopBits}"
                                                                  Text="{Binding ModbusToolModel.ModbusRtu_stopBits_select}" />
                                                    </StackPanel>
                                                </WrapPanel>
                                                <WrapPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0 5">

                                                        <Border HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"
                                                                Width="58">
                                                            <TextBlock Text="校验位" HorizontalAlignment="Right"
                                                                       Margin="5" />
                                                        </Border>
                                                        <ComboBox Margin="0 0 5 0" Width="90"
                                                                  ItemsSource="{Binding ModbusToolModel.ModbusRtu_parity}"
                                                                  SelectedIndex="0"
                                                                  Text="{Binding ModbusToolModel.ModbusRtu_parity_select}" />
                                                    </StackPanel>
                                                </WrapPanel>
                                            </StackPanel>
                                        </TabItem>
                                        <TabItem Width="122">
                                            <TabItem.Header>
                                                <TextBlock FontWeight="Bold" FontSize="13" Text="TCP服务器" />
                                            </TabItem.Header>
                                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                                <WrapPanel Margin="5">
                                                    <Border Margin="5">
                                                        <TextBlock Text="开启服务器端口号" FontSize="15"
                                                                   HorizontalAlignment="Center"
                                                                   VerticalAlignment="Center" />
                                                    </Border>
                                                    <ui:NumberBox Width="150"
                                                                  Value="{Binding ModbusToolModel.ModbusTcp_Port,UpdateSourceTrigger=PropertyChanged}"
                                                                  Minimum="0" Maximum="65535" />
                                                </WrapPanel>
                                            </StackPanel>
                                        </TabItem>
                                    </TabControl>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                        <Grid Grid.Row="1">
                            <StackPanel Orientation="Horizontal" Margin="0,10" HorizontalAlignment="Right">
                                <Button Content="收起" Width="100" Margin="15,0" Click="ButtonBase_OnClick" />
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>
            </WrapPanel>
        </Grid>
        <Grid Grid.Column="1" Cursor="Arrow">
            <StackPanel>
                <ui:TextBlock FontTypography="Subtitle" Text="日志" Margin="30 10" />
                <Border Margin="30 0"
                        Height="550"
                        BorderThickness="2"
                        CornerRadius="10"
                        Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}">
                    <ListBox Name="LogListBox"

                             ItemsSource="{Binding HomePageModel.LogListBox ,UpdateSourceTrigger=PropertyChanged}" />
                </Border>

                <StackPanel>
                    <WrapPanel HorizontalAlignment="Right">
                        <Button Content="清空日志" Click="ClearLog"/>
                        <Button Content="滚动到底部" Command="{Binding ScrollToBottomCommand}"
                                CommandParameter="{Binding  ElementName=LogListBox}" 
                                Margin="30 0" />
                    </WrapPanel>
                  
                </StackPanel>
            </StackPanel>

        </Grid>
        <ui:SnackbarPresenter Grid.ColumnSpan="2" Name="SnackbarPresenter" />
    </Grid>
</Page>